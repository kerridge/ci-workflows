name: "Lint & Test"

description: "Lints and tests"

inputs:
  github_token:
    description: "GitHub runner token"
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Analyze Flutter app
      shell: bash
      run: |
        fvm flutter analyze --no-fatal-infos --no-fatal-warnings

    - name: Test Flutter app
      shell: bash
      run: |
        fvm flutter test . --coverage

    # - name: Generate coverage report
    #   shell: bash
    #   run: |
    #     # Generate HTML coverage report
    #     fvm flutter test --coverage --coverage-path=coverage/lcov.info

    #     # Generate coverage summary
    #     if [ -f "coverage/lcov.info" ]; then
    #       # Install lcov if not available
    #       if ! command -v lcov &> /dev/null; then
    #         if command -v apt-get &> /dev/null; then
    #           sudo apt-get update && sudo apt-get install -y lcov
    #         elif command -v brew &> /dev/null; then
    #           brew install lcov
    #         fi
    #       fi

    #       # Generate summary
    #       lcov --summary coverage/lcov.info > coverage/summary.txt 2>/dev/null || echo "Could not generate lcov summary" > coverage/summary.txt

    #       # Calculate percentage
    #       if command -v lcov &> /dev/null; then
    #         PERCENT=$(lcov --summary coverage/lcov.info 2>/dev/null | grep "lines......:" | grep -oP "\d+\.\d+%" | head -1 || echo "N/A")
    #         echo "Coverage: $PERCENT" > coverage/percentage.txt

    #         # Generate detailed coverage report
    #         lcov --list coverage/lcov.info > coverage/detailed.txt 2>/dev/null || echo "Could not generate detailed coverage" > coverage/detailed.txt
    #       else
    #         echo "Coverage: N/A (lcov not available)" > coverage/percentage.txt
    #         echo "Detailed coverage not available" > coverage/detailed.txt
    #       fi
    #     else
    #       echo "No coverage data found" > coverage/summary.txt
    #       echo "Coverage: N/A" > coverage/percentage.txt
    #     fi

    # - name: Upload coverage reports
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: coverage-reports
    #     path: coverage/
    #     retention-days: 30

    # - name: Comment coverage on PR
    #   if: github.event_name == 'pull_request'
    #   shell: bash
    #   run: |
    #     if [ -f "coverage/percentage.txt" ]; then
    #       COVERAGE=$(cat coverage/percentage.txt)
    #       SUMMARY=$(cat coverage/summary.txt 2>/dev/null || echo "Coverage summary not available")
    #       DETAILED=$(cat coverage/detailed.txt 2>/dev/null | head -20 || echo "Detailed coverage not available")

    #       # Create comment body
    #       COMMENT="## ğŸ“Š Test Coverage Report

    #       **$COVERAGE**

    #       <details>
    #       <summary>ğŸ“‹ Coverage Summary</summary>

    #       \`\`\`
    #       $SUMMARY
    #       \`\`\`

    #       </details>

    #       <details>
    #       <summary>ğŸ“ File-by-File Coverage (Top 20)</summary>

    #       \`\`\`
    #       $DETAILED
    #       \`\`\`

    #       </details>

    #       ğŸ“¥ **Download Coverage Reports:** [Coverage Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

    #       ---
    #       *Generated by GitHub Actions*"

    #       # Post comment using GitHub API
    #       curl -X POST \
    #         -H "Authorization: token ${{ inputs.github_token }}" \
    #         -H "Accept: application/vnd.github.v3+json" \
    #         https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments \
    #         -d "{\"body\":\"$COMMENT\"}"
    #     fi
